<!doctype html>
<html>
<head>
	<title>Example of the Authorization Code flow with Spotify</title>
	<link rel="stylesheet" type="text/css" href="css/main.min.css">
	<style type="text/css">
		#login-template, #loggedin-template, #user-profile-template, #oauth-template, #error-template, #title-template, #footer-template, #playlists-template {
			display: none;
		}
	</style>
</head>
<body>


<div class="h-100">
	<div class="fixed-top">
		<div class="c-header  d-flex  flex-column  align-items-center  justify-content-center  bg-danger">
			<div id="title"><!-- placeholder-title-template --></div>
			<div id="error"><!-- placeholder-error-template --></div>
		</div>
	</div>
	<div id="playlists"></div>
	<div id="songs"></div>
	<div id="user-profile" class="h-100"></div>
	<div id="oauth" class="h-100"></div>
	<div id="login" class="h-100"></div>
	<div id="footer"></div>
</div>


<script id="footer-template" type="text/x-handlebars-template">
	<div class="fixed-bottom">
		<div class="c-audio-player  bg-danger">
			<div class="c-audio-player  d-flex  align-items-center  justify-content-center">
				<button class="btn btn-primary  mx-2" id="js-button--previous">Previous</button>
				<button class="btn btn-primary  mx-2" id="js-button--play">Play/Pause</button>
				<button class="btn btn-primary  mx-2" id="js-button--next">Next</button>
			</div>
		</div>
	</div>
</script>

<!-- templated are activated from the js below -->
<script id="login-template" type="text/x-handlebars-template">
	<div class="h-100  d-flex  flex-column  align-items-center  justify-content-center  text-center">
		<p>
			To be able to play your Spotify music, you need to have a valid spotify premium account. <br />
			To make sure this is the case and to be able to get your playlists and songs, Spotizzle requires you to login on Spotify. <br />
			This is the official Spotify login, not something Spotizzle has anything to do with, your data is safe :-)
		</p>
		<a href="/login" class="btn btn-primary">Log in with Spotify</a>
	</div>
</script>

<script id="loggedin-template" type="text/x-handlebars-template">
	<!--<div id="user-profile"></div>-->
	<!--<div id="oauth"></div>-->
	<button id="obtain-new-token" class="btn btn-primary  my-2">Obtain new token using the refresh token</button>
</script>

<script id="user-profile-template" type="text/x-handlebars-template">
	<div class="btn-group">
		<button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			{{display_name}}
		</button>
		<div class="dropdown-menu dropdown-menu-right">
			<a class="dropdown-item" href="#">Regular link</a>
			<a class="dropdown-item active" href="#">Active link</a>
			<div class="dropdown-divider"></div>
			<a class="dropdown-item" href="#">Another link</a>
		</div>
	</div>
</script>

<script id="oauth-template" type="text/x-handlebars-template">
	<div>Access token</div>
	<div>{{access_token}}</div>
	<div>Refresh token</div>
	<div>{{refresh_token}}</div>
</script>

<script id="error-template" type="text/x-handlebars-template">
	<span>{{statusCode}}: {{error}} - {{message}}</span>
</script>

<script id="title-template" type="text/x-handlebars-template">
	<span>{{title}}</span>
</script>

<script id="playlists-template" type="text/x-handlebars-template">
	<ul class="list-unstyled">
		{{#each playlists}}
		<li class="js-playlist  mb-2" data-id="{{this.id}}">
			{{#each this.images}}
			{{#unless @index}}
			<img style="max-width: 50px; max-height: 50px;" src="{{this.url}}" alt="Album cover">
			{{/unless}}
			{{/each}}
			{{this.name}} {{this.owner.display_name}} {{this.tracks.total}} {{this.description}}
		</li>
		{{else}}
		<li>No playlista have been found!</li>
		{{/each}}
	</ul>
</script>

<script id="songs-template" type="text/x-handlebars-template">
	<ul class="list-unstyled">
		{{#each songs}}
		<li class="js-song  mb-2" data-id="{{this.uri}}">
			{{#each this.artists}}
			{{this.name}}
			{{/each}}
			{{this.name}}
		</li>
		{{else}}
		<li>No songs have been found!</li>
		{{/each}}
	</ul>
</script>

<!-- replace with npm versions -->
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="https://sdk.scdn.co/spotify-player.js"></script> <!--Playing audio with spotify-->

<!--<script src="/script/index.js" type="module"></script>-->

<script>
    //todo: test with a free and a premium spotify account.
    //todo: replace handlebars with a js databinding viewmodel lib, now we always need to recompile the template
    //when to manually return a resolved promise instead of waiting
    //do calls on the server as much as possible?

    //    const backgroundStyles = {
    //        backgroundImage:`url(${props.item.album.images[0].url})`,
    //    };
    //
    //    const progressBarStyles = {
    //        width: (props.progress_ms * 100 / props.item.duration_ms) + '%'
    //    };

    (function () {
        window.onSpotifyWebPlaybackSDKReady = () => {
            let viewModel = {
                footer: {},
                error: {
                    statusCode: '999',
                    error: 'Error',
                    message: 'Something went wrong, but what?',
                },
                oauth: {},
                login: {},
                userProfile: {},
                title: {title: 'Spotizzle'},
                playlists: {playlists: []},
                songs: {songs: []}
            };

            //get the footer and pass a template with a model. Default application state hide/show after.
            var footer = document.getElementById('footer');
            footer.innerHTML = Handlebars.compile(document.getElementById('footer-template').innerHTML)(viewModel.footer);
            footer.style.display = 'none';

            var login = document.getElementById('login');
            login.innerHTML = Handlebars.compile(document.getElementById('login-template').innerHTML)(viewModel.login);
            login.style.display = 'none';

            var playlists = document.getElementById('playlists');
            playlists.innerHTML = Handlebars.compile(document.getElementById('playlists-template').innerHTML)(viewModel.playlists);
            playlists.style.display = 'none';

            var songs = document.getElementById('songs');
            songs.innerHTML = Handlebars.compile(document.getElementById('songs-template').innerHTML)(viewModel.songs);
            songs.style.display = 'none';

            var error = document.getElementById('error');
            error.innerHTML = Handlebars.compile(document.getElementById('error-template').innerHTML)(viewModel.error);
            error.style.display = 'none';

            var userProfile = document.getElementById('user-profile');
            userProfile.innerHTML = Handlebars.compile(document.getElementById('user-profile-template').innerHTML)(viewModel.userProfile);
            userProfile.style.display = 'none';

            var oauth = document.getElementById('oauth');
            oauth.innerHTML = Handlebars.compile(document.getElementById('oauth-template').innerHTML)(viewModel.oauth);
            oauth.style.display = 'none';

            var title = document.getElementById('title');
            title.innerHTML = Handlebars.compile(document.getElementById('title-template').innerHTML)(viewModel.title);
            title.style.display = 'none';


            //global variables
            var params = getHashParams();
            var access_token = params.access_token,
                refresh_token = params.refresh_token;
            var user_id = 0;
            var player;

            if (!access_token) {
                //update view
                viewModel.error = {
                    statusCode: '401',
                    error: 'Unauthorized',
                    message: 'You are not logged in. Please log in first.',
                };
                title.style.display = 'none'; //title and error share space, always one of both hidden.
                error.innerHTML = Handlebars.compile(document.getElementById('error-template').innerHTML)(viewModel.error);
                error.style.display = 'block';

                //also show the login view, since a user without access_token needs to login
                login.style.display = 'block';
            } else {
                //update view
                title.innerHTML = Handlebars.compile(document.getElementById('title-template').innerHTML)(viewModel.title);
                title.style.display = 'block';
                footer.style.display = 'block';

                viewModel.oauth = {
                    access_token: access_token,
                    refresh_token: refresh_token,
                };
                oauth.innerHTML = Handlebars.compile(document.getElementById('oauth-template').innerHTML)(viewModel.oauth);


                //get user information and update login/in
                let doneFunction = function (data, textStatus, jqXHR) {

                    //update view
                    viewModel.userProfile = {
                        display_name: 'test'
                    };
                    userProfile.innerHTML = Handlebars.compile(document.getElementById('user-profile-template').innerHTML)(viewModel.userProfile);

                    $('#login-template').hide();
                    $('#loggedin-template').show();
                };
                fetchData(viewModel, 'https://api.spotify.com/v1/me', {'Authorization': 'Bearer ' + access_token}, [], doneFunction);


                //get a now token click handler
//                document.getElementById('obtain-new-token').addEventListener('click', function () {
//                    getRefreshToken();
//                }, false);


                //create ajax calls in a loop
                //return them as array
                //$.when.apply($, thearray()).then(function(){
                // use results.
                // });

                function getRefreshToken() {
                    console.log('getting new token from /refresh_token, passing the refresh token');
                    return $.ajax({
                        url: '/refresh_token',
                        data: {
                            'refresh_token': refresh_token
                        }
                    }).done(function (data) {
                        access_token = data.access_token;

                        //update view
                        viewModel.oauth = {
                            access_token: access_token,
                            refresh_token: refresh_token,
                        };
                        oauth.innerHTML = Handlebars.compile(document.getElementById('oauth-template').innerHTML)(viewModel.oauth);
                    });
                };

                //get all playlists from current user
                function getCurrentUser() {
                    return $.ajax({
                        url: 'https://api.spotify.com/v1/me',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            //update view
                            viewModel.userProfile = {
                                display_name: 'test'
                            };
                            userProfile.innerHTML = Handlebars.compile(document.getElementById('user-profile-template').innerHTML)(viewModel.userProfile);

                            $('#login-template').hide();
                            $('#loggedin-template').show();
                        }
                    });
                }

                function getUserPlaylists() {
                    return getCurrentUser().then(function (response) {
                        user_id = response.id;

                        return $.ajax({
                            url: 'https://api.spotify.com/v1/users/' + user_id + '/playlists',
                            headers: {
                                'Authorization': 'Bearer ' + access_token
                            },
                            dataType: 'json',
                            data: {offset: 0, limit: '5'}
                        });
                    });
                };

                function getPlaylistSongs(clickedPlaylistId) {
                    return getUserPlaylists().then(function (response) { //userplaylists retrieved. update view and add click handler
                        viewModel.playlists.playlists = response.items;
                        playlists.innerHTML = Handlebars.compile(document.getElementById('playlists-template').innerHTML)(viewModel.playlists);
                        playlists.style.display = 'block';

                        $(".js-playlist").click(function (e) {
                            console.log("Get songs from clicked playlist");
                            getSongTitlesFromPlaylistSongs($(e.currentTarget).data("id"));
                        });

//                        currentPlaylist = viewModel.playlists.playlists[0].id;

                        return $.ajax({
                            url: 'https://api.spotify.com/v1/playlists/' + clickedPlaylistId + '/tracks',
                            headers: {
                                'Authorization': 'Bearer ' + access_token
                            },
                            dataType: 'json',
                            data: {fields: [], offset: 0, limit: '10'}
                        });
                    });
                };

                function getSongTitlesFromPlaylistSongs(playlistId) {
                    return getPlaylistSongs(playlistId).done(function (data) {
                        viewModel.songs.songs = [];

                        //get the current playlist using currentplaylist in the viewModel.playlists object, add the songs to that found object
                        for (let songCounter = 0; songCounter < data.items.length; songCounter++) {
                            let song = data.items[songCounter].track;
                            let artists = "";

                            for (let artistCounter = 0; artistCounter < song.artists.length; artistCounter++) {
                                artists += song.artists[artistCounter].name;
                            }
                            viewModel.songs.songs.push(song);
                        }

                        songs.innerHTML = Handlebars.compile(document.getElementById('songs-template').innerHTML)(viewModel.songs);
                        songs.style.display = 'block';

                        $(".js-song").click(function (e) {
                            playSong($(e.currentTarget).data("id"));
                        });
                    });
                }

                function playSong(songUri) {

                    //get token from https://developer.spotify.com/documentation/web-playback-sdk/quick-start/#
                    //if autoplaying music does not work ^
                    //required scopes for playing music: ["streaming", "user-read-email", "user-read-private"]
                    //

                    const token = 'BQDfnspHVUllgVTGZqmkaQRXtDTnAsnk1E6k9NOJqpcAkrSxENVjO8ZKuZd_yjVJvwl3E-fyzljXqUIa8_7B7W_WOXn3r1azHb8tdLtQg1CcE2og8jOsybEhdzLUytF5RQpn5YGPA670N4eqzhACV8-v1fPug5_J7ZA';
                    player = new Spotify.Player({
                        name: 'A Spotify Web SDK Player',
                        getOAuthToken: callback => {
                            callback(token);
                        },
                        volume: 0.1
                    });

                    // Called when connected to the player created beforehand successfully
                    player.addListener('ready', ({device_id}) => {
                        console.log('Ready with Device ID', device_id);

                        const play = ({
                                          spotify_uri,
                                          playerInstance: {
                                              _options: {
                                                  getOAuthToken,
                                                  id
                                              }
                                          }
                                      }) => {
                            getOAuthToken(access_token => {
                                fetch(`https://api.spotify.com/v1/me/player/play?device_id=${id}`, {
                                    method: 'PUT',
                                    body: JSON.stringify({uris: [spotify_uri]}),
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${access_token}`
                                    },
                                });
                            });
                        };

                        play({
                            playerInstance: player,
                            spotify_uri: songUri,
                        });
                    });

                    // Not Ready
                    player.addListener('not_ready', ({device_id}) => {
                        console.log('Device ID has gone offline', device_id);
                    });

                    // Connect to the player created beforehand, this is equivalent to
                    // creating a new device which will be visible for Spotify Connect
                    player.connect();
                }

                function getCurrentlyPlaying() {
                    // Make a call using the token
                    $.ajax({
                        url: "https://api.spotify.com/v1/me/player",
                        type: "GET",
                        beforeSend: (xhr) => {
                            xhr.setRequestHeader("Authorization", "Bearer " + access_token);
                        },
                        success: (data) => {
                            console.log(data);
                        }
                    });
                }

                getCurrentUser();
                getUserPlaylists();
                getPlaylistSongs();
//                getSongTitlesFromPlaylistSongs();

                window.addEventListener('keyup', function () {
                    console.log("keyup browser");
                }, true);


                $("#js-button--previous").click(function () {
                    player.previousTrack().then(() => {
                        console.log('Set to previous track!');
                    });
                });

                $("#js-button--play").click(function () { //play = pause
                    player.togglePlay().then(() => {
                        console.log('Toggled playback!');
                    });
                });

                $("#js-button--next").click(function () {
                    player.nextTrack().then(() => {
                        console.log('Skipped to next track!');
                    });
                });
            }
        };

        //add typescript to easily resolve parameter types
        function fetchData(viewModel, url, headers, dataArray, doneFunction = false, failFunction = false, alwaysFunction = false, dataType = 'json', debug = false) {
            if (debug) {
                debugger;
            }

            return $.ajax({
                url: url,
                headers: headers,
                data: dataArray,
                dataType: dataType,
            }).done(function (data, textStatus, jqXHR) {
                if (!doneFunction) {
                    //
                } else {
                    doneFunction(data, textStatus, jqXHR);
                }
            }).fail(function (jqXHR, textStatus, errorThrown) {
                if (!failFunction) {
                    console.log('Fetchdata client side api call error: ');
                    console.log(jqXHR.status + ': ' + jqXHR.statusText + ' - ' + jqXHR.responseJSON.error.message);

                    //update view
                    viewModel.error = {
                        statusCode: jqXHR.status,
                        error: jqXHR.statusText,
                        message: jqXHR.responseJSON.error.message,
                    };
                    title.style.display = 'none'; //title and error share space, always one of both hidden.
                    error.innerHTML = Handlebars.compile(document.getElementById('error-template').innerHTML)(viewModel.error);
                    error.style.display = 'block';
                    footer.style.display = "none";

                    if (jqXHR.status == 401) {
                        login.style.display = "block";
                    }
                } else {
                    failFunction();
                }
            }).always(function (data, textStatus, jqXHR) {
                if (!alwaysFunction) {
                    //hide loader
                } else {
                    alwaysFunction();
                }
            });
        };

        // Obtains parameters from the hash of the URL
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }
    })();
</script>
</body>
</html>

